#!/usr/bin/env bash
# Main dotfiles management CLI
# Inspired by https://github.com/dmmulroy/.dotfiles

set -e

DOTFILES="$HOME/.dotfiles"
COMMANDS_DIR="$DOTFILES/scripts/commands"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
info() {
  echo -e "${BLUE}ℹ${NC} $1"
}

success() {
  echo -e "${GREEN}✓${NC} $1"
}

warn() {
  echo -e "${YELLOW}⚠${NC} $1"
}

error() {
  echo -e "${RED}✗${NC} $1"
}

usage() {
  cat << EOF
dot - Dotfiles management CLI

Usage:
  dot <command> [options]

Commands:
  setup       Initial setup for a new machine
  link        Link dotfiles using GNU Stow
  unlink      Remove dotfile symlinks
  doctor      Run diagnostics on dotfiles setup
  update      Update packages and tools
  package     Manage Brewfile packages
  help        Show this help message

Options:
  --dry-run   Show what would happen without making changes (where supported)
  --help      Show command-specific help

Examples:
  dot setup --dry-run    # Preview setup without making changes
  dot link               # Link all dotfiles
  dot doctor             # Check system health
  dot package add bat    # Add package to Brewfile and install

Run 'dot <command> --help' for more information on a specific command.
EOF
}

# Main command dispatcher
main() {
  if [[ $# -eq 0 ]]; then
    usage
    exit 0
  fi

  local command="$1"
  shift

  case "$command" in
    setup)
      source "$COMMANDS_DIR/setup.sh"
      cmd_setup "$@"
      ;;
    link)
      source "$COMMANDS_DIR/link.sh"
      cmd_link "$@"
      ;;
    unlink)
      source "$COMMANDS_DIR/unlink.sh"
      cmd_unlink "$@"
      ;;
    doctor)
      source "$COMMANDS_DIR/doctor.sh"
      cmd_doctor "$@"
      ;;
    update)
      source "$COMMANDS_DIR/update.sh"
      cmd_update "$@"
      ;;
    package)
      source "$COMMANDS_DIR/package.sh"
      cmd_package "$@"
      ;;
    help|--help|-h)
      usage
      exit 0
      ;;
    *)
      error "Unknown command: $command"
      echo ""
      usage
      exit 1
      ;;
  esac
}

main "$@"
