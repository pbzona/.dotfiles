#!/usr/bin/env bash
# Global pre-commit hook - ANTI-SLOP BOT 2000
# This file is managed by dotfiles - edit there, not here
set -euo pipefail
cd "$(git rev-parse --show-toplevel)" || exit 1

# Per-project disable check
[[ -f .git/hooks/anti-slop-disable ]] && exit 0

# Run local hook first (husky, lint-staged, etc.)
LOCAL_HOOK="$(git rev-parse --git-dir)/hooks/pre-commit"
[[ -x "$LOCAL_HOOK" ]] && { "$LOCAL_HOOK" "$@" || exit 1; }

# Config
TIMEOUT_SECONDS="${ANTI_SLOP_TIMEOUT:-90}"
MODEL="${ANTI_SLOP_MODEL:-opus}"
MAX_DIFF_LINES="${ANTI_SLOP_MAX_LINES:-2000}"
ENABLED="${ANTI_SLOP:-1}"

[[ "$ENABLED" == "0" ]] && exit 0
command -v claude &>/dev/null || exit 0

CODE_EXT='(js|jsx|ts|tsx|py|go|rs|java|kt|swift|c|cpp|h|hpp|rb|php|cs|scala|sh|bash|zsh|vue|svelte|astro|md|json|yaml|yml|toml)'
STAGED=$(git diff --cached --name-only --diff-filter=ACMR | grep -E "\.${CODE_EXT}$" || true)
[[ -z "$STAGED" ]] && exit 0

DIFF=$(git diff --cached -U5)
DIFF_LINES=$(echo "$DIFF" | wc -l | tr -d ' ')
[[ "$DIFF_LINES" -gt "$MAX_DIFF_LINES" ]] && exit 0

echo -e "\033[0;35m    ðŸ¤– ANTI-SLOP BOT 2000\033[0m"
echo -e "\033[0;36mðŸ“‹ Reviewing $(echo "$STAGED" | wc -l | tr -d ' ') file(s), ${DIFF_LINES} lines...\033[0m"

SYSTEM_PROMPT='You are the ANTI-SLOP BOT 2000, an elite code quality guardian.

Your mission: Detect and REJECT low-quality "slop" code before it pollutes the codebase.

## What is "Slop"?
- Security vulnerabilities (SQL injection, XSS, command injection, hardcoded secrets)
- Obvious bugs (null derefs, off-by-one errors, race conditions, unclosed resources)
- Dead code (unused imports, unreachable code, commented-out blocks)
- Console.log/print debugging left in production code
- TODO/FIXME/HACK comments in new code
- Empty catch blocks that swallow errors
- Sensitive data exposure (API keys, passwords, tokens)

## What is NOT Slop (ignore):
- Style preferences (not a linter)
- Missing docs, test coverage, architecture decisions
- Existing code that was not changed

## Output: JSON only
APPROVED: {"status":"APPROVED","message":"..."}
REJECTED: {"status":"REJECTED","summary":"...","issues":[{"severity":"critical|high|medium","file":"...","line":42,"type":"security|bug|debug|secrets","message":"...","suggestion":"..."}]}

RULES: Only analyze + lines. Do not invent issues. Be strict but fair.'

JSON_SCHEMA='{"type":"object","properties":{"status":{"type":"string","enum":["APPROVED","REJECTED"]},"message":{"type":"string"},"summary":{"type":"string"},"issues":{"type":"array","items":{"type":"object","properties":{"severity":{"type":"string","enum":["critical","high","medium"]},"file":{"type":"string"},"line":{"type":"integer"},"type":{"type":"string"},"message":{"type":"string"},"suggestion":{"type":"string"}},"required":["severity","file","type","message","suggestion"]}}},"required":["status"]}'

PROMPT="Review this git diff. PROJECT: $(basename $(pwd))
FILES: ${STAGED}
DIFF:
\`\`\`diff
${DIFF}
\`\`\`"

TEMP=$(mktemp); trap "rm -f $TEMP" EXIT

timeout "${TIMEOUT_SECONDS}s" claude -p \
    --setting-sources "" \
    --mcp-config '{"mcpServers":{}}' \
    --strict-mcp-config \
    --add-dir "$(pwd)" \
    --model "$MODEL" \
    --system-prompt "$SYSTEM_PROMPT" \
    --output-format json \
    --json-schema "$JSON_SCHEMA" \
    "$PROMPT" > "$TEMP" 2>&1 || { echo -e "\033[1;33mâš ï¸ Timeout/error, allowing commit\033[0m"; exit 0; }

RESULT=$(cat "$TEMP")
if echo "$RESULT" | jq -e '.structured_output' &>/dev/null; then
    JSON=$(echo "$RESULT" | jq '.structured_output')
else
    JSON="$RESULT"
fi

STATUS=$(echo "$JSON" | jq -r '.status // "UNKNOWN"')

if [[ "$STATUS" == "APPROVED" ]]; then
    echo -e "\033[0;32mâœ… APPROVED: $(echo "$JSON" | jq -r '.message')\033[0m"
    exit 0
elif [[ "$STATUS" == "REJECTED" ]]; then
    echo -e "\033[0;31mðŸš« REJECTED: $(echo "$JSON" | jq -r '.summary')\033[0m"
    echo "$JSON" | jq -r '.issues[]? | "  [\(.severity|ascii_upcase)] \(.file):\(.line//"?") - \(.message)\n    ðŸ’¡ \(.suggestion)"'
    echo -e "\033[1;33mUse 'git commit --no-verify' to bypass\033[0m"
    exit 1
fi
exit 0
